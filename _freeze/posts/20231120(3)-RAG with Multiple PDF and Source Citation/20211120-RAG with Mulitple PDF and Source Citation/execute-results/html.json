{
  "hash": "3764a5af0470a3e391007fb294c1f56a",
  "result": {
    "markdown": "---\ntitle: \"Retrieval Augmented Generation with Multiple PDF and Citation\"\ndescription: \"An applied example using langchain\"\nauthor: \"Luke Heley\"\ndate: \"20 Nov 23\"\nfreeze: true\nexecute:\n  eval: true\nformat:\n  html:\n    toc: true\n    code-fold: show\ncategories:\n - large language models (LLM)\n - evidence synthesis\n - methods\n - notes\neditor_options:\n  chunk_output_type: console\n---\n\n# Introduction\n\nhttps://python.langchain.com/docs/use_cases/question_answering/\n\n# Build the Knowledge Base\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport sys\n\nfrom langchain.document_loaders import PyPDFLoader\n\npdf_url = \"https://www.nao.org.uk/wp-content/uploads/2015/10/Major-Projects-Report-2015-and-the-Equipment-Plan-2015-2025.pdf\" # also allowed is a file path e.g. /home/downloads/xyz.pdf\nurl2 = \"https://www.nao.org.uk/wp-content/uploads/2010/10/1011489_I.pdf\"\nurls = [url2, pdf_url]\n\ndocuments = []\nfor url in urls:\n        documents.extend(PyPDFLoader(url).load())\n\n```\n:::\n\n\n# Chunk \n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\n# Split\nfrom langchain.text_splitter import RecursiveCharacterTextSplitter\ntext_splitter = RecursiveCharacterTextSplitter(\n    chunk_size = 1500,\n    chunk_overlap = 150\n)\n\ndocs = text_splitter.split_documents(documents)\n\nprint(\"Length of pages: \", len(documents))\nprint(\"Length of splits: \", len(docs))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLength of pages:  138\nLength of splits:  274\n```\n:::\n:::\n\n\n# Embed and Store\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nfrom langchain.embeddings.openai import OpenAIEmbeddings\nfrom langchain.vectorstores import Chroma\n\nembeddings = OpenAIEmbeddings()\n\nvectorstore = Chroma.from_documents(\n    documents=docs,\n    embedding=embeddings,\n    persist_directory=\"data\"\n)\n\nprint(vectorstore._collection.count()) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n274\n```\n:::\n:::\n\n\n# Retrieve\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\nretriever = vectorstore.as_retriever(search_type=\"similarity\", search_kwargs={\"k\": 6})\nretrieved_docs = retriever.get_relevant_documents(\n    \"What are the causes of schedule variation?\"\n)\n\nlen(retrieved_docs)\nprint(retrieved_docs[0].page_content)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nof activities to reflect slower-than-expected progress was an important contributory \nfactor. There is evidence to support the view that this is still the case for our sample of \nprocurement projects, which had a net underspend of Â£295 million in 2014-15, compared \nwith a slight overspend in 2013-14. A significant contributory factor was the movement of \nactivity into future years, both planned and unplanned (paragraphs 2.9 to 2.12).\n```\n:::\n:::\n\n\n# Generate\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\nfrom langchain.chat_models import ChatOpenAI\nllm = ChatOpenAI(model_name=\"gpt-3.5-turbo\", temperature=0)\n\nfrom langchain import hub\nprompt = hub.pull(\"rlm/rag-prompt\")\n\nfrom langchain.schema import StrOutputParser\nfrom langchain.schema.runnable import RunnablePassthrough\n\n\ndef format_docs(docs):\n    return \"\\n\\n\".join(doc.page_content for doc in docs)\n\n\nrag_chain = (\n    {\"context\": retriever | format_docs, \"question\": RunnablePassthrough()}\n    | prompt\n    | llm\n    | StrOutputParser()\n)\n\nfor chunk in rag_chain.stream(\"What are the causes of schedule variation?\"):\n    print(chunk, end=\"\", flush=True)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nThe causes of schedule variation include slower-than-expected progress, movement of activity into future years (both planned and unplanned), technical difficulties, and uncertainties around projects that are not 'on contract'. Inflation and cost modeling can also contribute to schedule variation.\n```\n:::\n:::\n\n\n# Custom Prompt\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\nfrom langchain.prompts import PromptTemplate\n\ntemplate = \"\"\"Use the following pieces of context to answer the question at the end. \nIf you don't know the answer, just say that you don't know, don't try to make up an answer. \nUse three sentences maximum and keep the answer as concise as possible. \nAlways say \"thanks for asking!\" at the end of the answer. \n{context}\nQuestion: {question}\nHelpful Answer:\"\"\"\nrag_prompt_custom = PromptTemplate.from_template(template)\n\nrag_chain = (\n    {\"context\": retriever | format_docs, \"question\": RunnablePassthrough()}\n    | rag_prompt_custom\n    | llm\n    | StrOutputParser()\n)\n\nrag_chain.invoke(\"What are the causes of schedule variation?\")\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\n\"The causes of schedule variation include the movement of activity into future years, both planned and unplanned, as well as technical difficulties and delays. Uncertainty around projects that are not 'on contract' and the treatment of inflation also contribute to schedule variation. Thanks for asking!\"\n```\n:::\n:::\n\n\n# Adding Sources\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\nfrom operator import itemgetter\nfrom langchain.schema.runnable import RunnableMap\n\nrag_chain_from_docs = (\n    {\n        \"context\": lambda input: format_docs(input[\"documents\"]),\n        \"question\": itemgetter(\"question\"),\n    }\n    | rag_prompt_custom\n    | llm\n    | StrOutputParser()\n)\n\nrag_chain_with_source = RunnableMap(\n    {\"documents\": retriever, \"question\": RunnablePassthrough()}\n) | {\n    \"documents\": lambda input: [doc.metadata for doc in input[\"documents\"]],\n    \"answer\": rag_chain_from_docs,\n}\n\nrag_chain_with_source.invoke(\"What are the main causes of schedule variation in MOD?\")\n\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```\n{'documents': [{'page': 9,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2015/10/Major-Projects-Report-2015-and-the-Equipment-Plan-2015-2025.pdf'},\n  {'page': 10,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2015/10/Major-Projects-Report-2015-and-the-Equipment-Plan-2015-2025.pdf'},\n  {'page': 36,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2010/10/1011489_I.pdf'},\n  {'page': 74,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2015/10/Major-Projects-Report-2015-and-the-Equipment-Plan-2015-2025.pdf'},\n  {'page': 13,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2010/10/1011489_I.pdf'},\n  {'page': 23,\n   'source': 'https://www.nao.org.uk/wp-content/uploads/2015/10/Major-Projects-Report-2015-and-the-Equipment-Plan-2015-2025.pdf'}],\n 'answer': 'The main causes of schedule variation in MOD are delays in the development of certain sub-systems, technical difficulties, and the movement of activity into future years. Thanks for asking!'}\n```\n:::\n:::\n\n\n",
    "supporting": [
      "20211120-RAG with Mulitple PDF and Source Citation_files"
    ],
    "filters": [],
    "includes": {}
  }
}