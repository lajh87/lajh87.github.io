---
title: "GES Competency Framework"
description: "Post description"
author: "Luke Heley"
date: "15/10/2022"
categories:
  - cpd
  - scrape
  - economics
  - reactable
---


```{r}
url <- "https://www.gov.uk/government/publications/ges-technical-framework-2022/1-application-of-knowledge"
req <- httr::GET(url)

content <- httr::content(req) |>
  xml2::xml_find_all("//div[@class = 'govspeak']//ul") |>
  purrr::map(~.x |> xml2::xml_children() |> xml2::xml_text())

level <-httr::content(req) |>
  xml2::xml_find_all("//div[@class = 'govspeak']//h3") |>
  xml2::xml_text()  |>
  stringr::str_remove_all("\n")

heading <- httr::content(req) |>
  xml2::xml_find_all("//div[@class = 'govspeak']//h2") |>
  xml2::xml_text() |>
  stringr::str_remove_all("\n")

index <- substr(level, 1, stringr::str_locate(level, "\\.")[, "start"]-1) |>
  as.numeric()

heading_level <- heading[index]


tbl <- purrr::map_df(seq_along(level), {
  ~dplyr::tibble(
    heading = heading_level[.x], 
    level = level[.x], 
    content = content[[.x]]
  )
}) |>
  dplyr::mutate(heading_index = as.numeric(substr(heading, 1, stringr::str_locate(heading, "\\s")[,"start"]-2))) |>
  dplyr::mutate(level_index = as.numeric(substr(level, 3, stringr::str_locate(level, "\\s")[,"start"]-1))) |>
  dplyr::mutate(heading = substr(heading, stringr::str_locate(heading, "\\s")+1, nchar(heading))) |>
  dplyr::mutate(level = substr(level, stringr::str_locate(level, "\\s")+1, nchar(level))) |>
  dplyr::mutate(level = stringr::str_remove_all(level, "\\[footnote 1\\]")) |>
  dplyr::group_by(heading_index, level_index) |>
  dplyr::mutate(content_index = 1:dplyr::n()) |>
  dplyr::mutate(index = paste(heading_index, level_index, content_index, sep = ".")) |>
  dplyr::ungroup() 


tbl |>
  dplyr::select(index, heading, level, content) |>
  dplyr::mutate(heading = as.factor(heading)) |>
  dplyr::mutate(level = as.factor(level)) |>
  DT::datatable(filter = "top", rownames = FALSE,
                extensions = 'RowGroup',
                options = list(
                  rowGroup = list(dataSrc = c(1)),
                  dom = "ts", paging = FALSE,
                  columnDefs = list(list(visible=FALSE, targets=c(1)))),
                selection = 'none')

```